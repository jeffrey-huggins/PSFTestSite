function updateTable(){var r=$("#occurredRangeFrom").val(),u=checkDate(r),t,i,n,f;if(u=="invalid")return alert("Error: Please enter a valid From Date (mm/dd/yyyy)"),!1;if(u=="infuture")return alert("Error: You can not have a From date that is in the future"),!1;if(t=$("#occuredRangeTo").val(),i=checkDate(t),i=="invalid")return alert("Error: Please enter a valid To Date (mm/dd/yyyy)"),!1;if(i=="infuture")return alert("Error: You can not have a To date that is in the future"),!1;n=$("#Residents option:selected").val();n!="0"&&n!=""&&(f=path+"IncidentTracking/PatientInfo?="+n,$("#selectedResidentView").load(f,function(){$("#title").text("Incident Tracking for "+$("#residentName").text())}),$("#listing").load(path+"IncidentTracking/GetIncidentList?patientId="+n+"&fromString="+encodeURIComponent(r)+"&toString="+encodeURIComponent(t),function(){$("#incidentTable").dataTable({bFilter:!1,bAutoWidth:!1,aaSorting:[[2,"desc"]],sDom:"frtS",iDisplayLength:-1})}),loadForm())}function loadForm(){var n=$("#Residents option:selected").val();n==""||n=="0"?($(".instruction").hide(),$("#listing").html(""),$("#title").text("Incident Tracking")):$("#editForm").load(path+"IncidentTracking/EditIncident?patientId="+n,editFormLoaded)}function editFormLoaded(){addIndex=0;$("#addDocument").on("click",function(){var n=$("<div>").load(path+"IncidentTracking/CreateNewDocument",function(){ApplyUniqueItemIndex($(n),addIndex,"Documents");$("#incidentDocuments").append(n);addIndex++})});$("#incidentDocuments").on("click",".delete-item",function(){var n=$(this).closest("div"),t=n.find("[data-field='Id']").val(),i;t!="0"?(i=path+"IncidentTracking/DeleteIncidentEventDocument?id="+t,$.ajax({url:i,success:function(t){t.success&&n.remove()},error:function(){alert("Server is not responding. Please reload page and try again")}})):($(this).closest("div").remove(),FixDocumentIndex())});$.validator.setDefaults({ignore:[]});$("#saveIncidentForm").removeData("validator");$("#saveIncidentForm").removeData("unobtrusiveValidation");$.validator.unobtrusive.parse($("#saveIncidentForm"));$("#saveIncidentForm").validate();$("#Event_PatientIncidentEventId").val()=="0"&&$("#Event_IncidentDateTime").val("");$("#interventionTable").dataTable({bAutoWidth:!1,sScrollY:"150px",sDom:"rt",iDisplayLength:-1,bSort:!1,aoColumns:[{bSortable:!1},{bSortable:!1}]});$("#treatmentTable").dataTable({bAutoWidth:!1,sScrollY:"150px",bSort:!1,sDom:"rt",iDisplayLength:-1,iDisplayLength:-1,aoColumns:[{bSortable:!1},{bSortable:!1}]});$(".instruction").hide();$(".isDate").datepicker();$(".isDateTime").datetimepicker({timeFormat:"hh:mm tt"});$("#Event_ReportedToStateFlg").is(":checked")&&$("#Event_ReportedToStateDateTime").rules("add",{no_future_datetime:!0,required:!0,date_before_incident:!0});$(".reportedState").toggle($("#Event_ReportedToStateFlg").is(":checked"));$("#Event_ReportedToStateFlg").on("click",function(){$(".reportedState").toggle($("#Event_ReportedToStateFlg").is(":checked"));$(this).is(":checked")?$("#Event_ReportedToStateDateTime").rules("add",{required:!0,date_before_incident:!0,no_future_datetime:!0}):($("#Event_ReportedToStateDateTime").rules("remove"),$("#Event_ReportedToStateDateTime").val(""))});$(".inBuildingDate").toggle($("#Event_StateInBuildingFlg").is(":checked"));$("#Event_StateInBuildingFlg").is(":checked")&&$("#Event_StateInBuildingDate").rules("add",{required:!0,date_before_incident_time:!0,no_future_date:!0});$("#Event_StateInBuildingFlg").on("click",function(){$(".inBuildingDate").toggle($("#Event_StateInBuildingFlg").is(":checked"));$(this).is(":checked")?$("#Event_StateInBuildingDate").rules("add",{required:!0,date_before_incident_time:!0,no_future_date:!0}):($("#Event_StateInBuildingDate").rules("remove"),$("#Event_StateInBuildingDate").val(""))});$(".regionSelected").toggle($("#Event_RegionalNurseClosedFlg").is(":checked"));$("#Event_RegionalNurseClosedFlg").is(":checked")&&$("#Event_RegionalNurseEmployeeId").rules("add",{required:!0});$("#Event_RegionalNurseClosedFlg").on("click",function(){$(".regionSelected").toggle($("#Event_RegionalNurseClosedFlg").is(":checked"));$(this).is(":checked")?$("#Event_RegionalNurseEmployeeId").rules("add",{required:!0}):($("#Event_RegionalNurseEmployeeId").rules("remove"),$("#Event_RegionalNurseEmployeeId").val(""))});$("#saveIncident").on("click",function(n){var i,t;n.preventDefault();var u=$("#saveIncidentForm"),r=[],f=$("[type='file'"),e=$("#incidentDocuments").find("a");for(t=0;t<e.length;t++)i=$(e[t]).text().trim(),r.push(i);for(t=0;t<f.length;t++){var s=$(f[t]).val(),o=s.split("\\"),i=o[o.length-1];if(r.indexOf(i)>=0){alert("A file with the name "+i+" is being added twice.  Delete the old file or rename the new file to continue.");return}r.push(i)}u.valid()&&u.ajaxSubmit({dataType:"json",contentType:"application/json; charset=utf-8",success:function(n){var t,i;n.success?($("#SaveDocuments").find("input").length>0&&(FixDocumentIndex(),t=n.id,$("[data-field='ParentId']").val(t),i=$("#SaveDocuments"),i.ajaxSubmit({})),updateTable(),loadForm()):alert(n.data)},error:function(){alert("Server is not responding. Please reload page and try again")}})});$("#clearIncident").on("click",function(n){n.preventDefault();loadForm()})}function initSidebar(){$("#LookbackDate").datepicker({beforeShow:function(n,t){t.dpDiv.css({marginTop:"10px",marginLeft:"0px"})}});$("#Residents").val("");$("#title").text("Incident Tracking");$(".instruction").show();$("#editForm").html("");$("#listing").html("")}function ApplyUniqueItemIndex(n,t,i){n.find("input").each(function(){var n=$(this).data("field");this.id=i+"_"+t+"__"+n;this.setAttribute("name",i+"["+t+"]."+n)})}function FixDocumentIndex(){var n=$("#documentSection").find("[type='file']");for(addIndex=0;addIndex<n.length;addIndex++)ApplyUniqueItemIndex($(n[addIndex]).closest("div"),addIndex,"Documents")}var addIndex=0;$("#sideBar").on("change","#Residents",function(){updateTable()});$("#sideBar").on("click","#lookbackUpdate",function(n){n.preventDefault();var i=getMomentDate($("#LookbackDate").val()),t=checkDate($("#LookbackDate").val());t=="invalid"?alert("Error: Please enter a valid Last Census Date (mm/dd/yyyy)"):t=="infuture"?alert("Error: You can not have a Census date that is in the future"):(ShowProgress(),$("#SideDDL").ajaxSubmit({url:path+"IncidentTracking/UpdateSideBar",type:"POST",success:function(n){$("#sideBar").html(n);initSidebar()}}))});$("#sideBar").on("change","#Communities",function(){ShowProgress();$("#SideDDL").ajaxSubmit({url:path+"IncidentTracking/UpdateSideBar",type:"POST",success:function(n){$("#sideBar").html(n);initSidebar()}})});$("#listing").on("click",".edit",function(n){n.preventDefault();$("#editForm").load(this.href,editFormLoaded)});$("#listing").on("click",".delete",function(n){n.preventDefault();$.ajax({type:"POST",url:this.href,success:function(n){n.Success?updateTable():alert("Unable to delete row, try refreshing the page and try again.")}})});$(".isDate").datepicker();$("#updateTable").on("click",updateTable);