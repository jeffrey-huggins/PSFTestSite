function SetReadonly(n){$("input[type=text], textarea",n).prop("readonly",!0);$("input[type=checkbox], select, button",n).prop("disabled",!0);$(".OrderStatus",n).prop("readonly",!1)}function InitializeDates(){$(".isDate").each(function(n,t){$(t).val().indexOf("1/1/0001")>-1&&$(t).val("");$(t).val().indexOf(" ")>-1&&$(t).val($(t).val().split(" ")[0])});$(".isDate").datepicker({beforeShow:function(n,t){t.dpDiv.css({marginTop:-n.offsetHeight+"px",marginLeft:n.offsetWidth+"px"})}})}function AdjustPurchaseOrderItem(n,t){$("td input",n).add("td textarea",n).each(function(){var n=$(this).data("field");this.id="Items_"+t+"__"+n;this.setAttribute("name","Items["+t+"]."+n)})}function FormatDate(n){var t=new Date(parseInt(n.substr(6))),i=t.getDate(),r=t.getMonth()+1,u=t.getFullYear();return r+"/"+i+"/"+u}function SumPurchaseOrderItems(n){var t=0;return $(".TotalCost",n).each(function(){var n=parseFloat(this.innerHTML);t+=n}),t}function UpdateOrderTotals(n){var r=SumPurchaseOrderItems(n),i=$("#EstimatedTaxCost").val(),t,u;(i==undefined||i=="")&&(i="0");t=$("#EstimatedFreightCost").val();(t==undefined||t=="")&&(t="0");u=r+parseFloat(i)+parseFloat(t);$("#Subtotal").html(r.toFixed(2));$("#EstimatedTotalCost").html(u.toFixed(2))}function UpdateAllowFinalApproval(n){var t=$("#HasPreexistingApproval"),i;t&&t.val()==="False"&&(i=$("input.Approval:checked",n),i.length===0?($("#HasFinalApproval").prop("checked",!1),$("#HasFinalApproval").prop("disabled",!0)):$("#HasFinalApproval").prop("disabled",!1))}function MonitorAllowFinalApproval(n){$(".Approval",n).change(function(){UpdateAllowFinalApproval()});UpdateAllowFinalApproval()}function SetupCostControls(n){var t=$("#IsTaxIncluded",n),i=$("#IsFreightIncluded",n);t.prop("checked")&&$("#EstimatedTaxCost",n).val("0.00").attr("readonly","readonly").prop("readonly",!0);t.change(function(){t.prop("checked")?$("#EstimatedTaxCost",n).val("0.00").attr("readonly","readonly").prop("readonly",!0):$("#EstimatedTaxCost",n).removeAttr("readonly").prop("readonly",!1)});i.prop("checked")&&$("#EstimatedFreightCost",n).val("0.00").attr("readonly","readonly").prop("readonly",!0);i.change(function(){i.prop("checked")?$("#EstimatedFreightCost",n).val("0.00").attr("readonly","readonly").prop("readonly",!0):$("#EstimatedFreightCost",n).removeAttr("readonly").prop("readonly",!1)})}function SetupDropDownLists(n){$("#PurchaseOrderTypeId, #PurchaseOrderAssetClassId",n).chosen({disable_search_threshold:100,width:"120px"});$("#VendorId",n).chosen({no_results_text:"no matches found!",width:"200px"})}function CapitalExpenseLevel2(){var n=$("#IsCapitalExpense").prop("checked"),t=$("#IsLevel2MarkedForApproval").prop("checked"),i=$("#IsLevel3MarkedForApproval").prop("checked"),r=$("#IsLevel4MarkedForApproval").prop("checked");return n==!0?r==undefined&&i==undefined&&t!=undefined?($("#IsMarkedForFinalApproval").prop("checked",!1),$("#IsMarkedForFinalApproval").prop("disabled",!0),!0):!1:DenyChecked(this)==!1?($("#IsLevel2MarkedForApproval").prop("disabled",!1),$("#IsMarkedForFinalApproval").prop("disabled",!1),!1):void 0}function DenyChecked(){var n=$("#IsMarkedForDenial").prop("checked");return n!=undefined&&n==!0?($("input#IsMarkedForFinalApproval").prop("checked",!1),$("input[id$=MarkedForApproval]").prop("checked",!1),$("input#IsMarkedForFinalApproval").prop("disabled",!0),$("input[id$=MarkedForApproval]").prop("disabled",!0),!0):($("input#IsMarkedForFinalApproval").prop("disabled",!1),$("input[id$=MarkedForApproval]").prop("disabled",!1),!1)}function RemoveApprovalEvents(){$("input#IsMarkedForFinalApproval").off();$("input[id$=MarkedForApproval]").off()}function AddApprovalEvents(){$("input#IsMarkedForFinalApproval").on("change",function(){CapitalExpenseLevel2(this)==!1&&(ApprovalRules(this),NoneApproved(this))});$("input[id$=MarkedForApproval]").on("change",function(){CapitalExpenseLevel2(this)==!1&&NoneApproved(this)})}function NoneApproved(){var u=$("#IsMarkedForFinalApproval").prop("checked"),n=$("#IsLevel2MarkedForApproval").prop("checked"),t=$("#IsLevel3MarkedForApproval").prop("checked"),i=$("#IsLevel4MarkedForApproval").prop("checked"),r=$("#HasPreexistingApproval").val();u==!0&&(i==!1||i==undefined)&&(t==!1||t==undefined)&&(n==!1||n==undefined)&&(r==!1||r==undefined)&&$("#IsMarkedForFinalApproval").prop("checked",!1)}function ApprovalRules(){var t=$("#IsMarkedForFinalApproval").prop("checked"),n=$("#IsLevel4MarkedForApproval").prop("checked"),i=$("#IsLevel3MarkedForApproval").prop("checked"),r=$("#IsLevel2MarkedForApproval").prop("checked");t==!0&&n==!1?($("#IsLevel4MarkedForApproval").prop("checked",!0),n=!0):t==!0&&n==undefined&&i==!1?($("#IsLevel3MarkedForApproval").prop("checked",!0),i=!0):t==!0&&n==undefined&&i==undefined&&r==!1&&($("#IsLevel2MarkedForApproval").prop("checked",!0),r=!0)}function PreparePage(){function u(n){$("td input",n).add("td textarea",n).each(function(){var n=$(this).data("field");this.id="Documents_"+i+"__"+n;this.setAttribute("name","Documents["+i+"]."+n)});i++}var n=$("#formContent"),t=$("#purchaseOrderTable").dataTable({bAutoWidth:!1,sScrollY:"600px",sDom:"rt",iDisplayLength:-1,aoColumns:[null,null,{sWidth:"40px"},{sWidth:"40px"},{sWidth:"40px"},{sWidth:"50px"},{sWidth:"50px"},{sWidth:"50px"},{sWidth:"50px"},{sWidth:"30px"},{sWidth:"20px",bSortable:!1},{sWidth:"30px",bSortable:!1}],oLanguage:{sEmptyTable:"No records within this range."}}),r,i;t.fnSort([[0,"desc"]]);t.on("click",".delete-link",function(i){var r=$(this);i.preventDefault();confirm("Are you sure you would like to delete this purchase order?")&&$.ajax({url:r.attr("href"),type:"post",success:function(i){if(i.Success){var u=r.closest("tr"),f=u.get(0),e=t.fnGetPosition(f);t.fnDeleteRow(e);(u.attr("id")==$("#PurchaseOrderId").val()||u.attr("id")==$("#PurchaseOrder_PurchaseOrderId").val())&&n.hide()}SetCountDownTime(1800)},error:function(){alert("Could not communicate with the server.")}})});t.on("click",".edit-link",function(t){var i=$(this);t.preventDefault();$.ajax({url:i.attr("href"),success:function(t){n.html(t);$("#HasFinalApproval",n).prop("checked")&&SetReadonly(n);InitializeDates();MonitorAllowFinalApproval(n);SetupCostControls(n);SetupDropDownLists(n);n.show();$(".ItemDescription",n).autogrow({onInitialize:!0,fixMinHeight:!1})},error:function(){alert("Could not communicate with the server.")}})});t.on("click",".view-link",function(t){var i=$(this);t.preventDefault();$.ajax({url:i.attr("href"),success:function(t){n.html(t);n.show()},error:function(){alert("Could not communicate with the server.")}})});$("#create").click(function(t){var i=$(this);t.preventDefault();$.ajax({url:i.attr("href")+"/"+$("#CurrentCommunity").val(),success:function(t){n.html(t);InitializeDates();MonitorAllowFinalApproval(n);SetupCostControls(n);SetupDropDownLists(n);n.show()},error:function(){alert("Could not communicate with the server.")}})});r=0;n.on("change","#IsSpecialProject",function(){$("#IsSpecialProject").prop("checked")==!0&&$("#IsEmergency").prop("checked",!1)});n.on("change","#IsEmergency",function(){$("#IsEmergency").prop("checked")==!0&&$("#IsSpecialProject").prop("checked",!1)});n.on("change","#IsPurchaseOrder",function(){$("#IsPurchaseOrder").prop("checked")==!0&&$("#IsCapitalExpense").prop("checked",!1)});n.on("change","#IsCapitalExpense",function(){$("#IsCapitalExpense").prop("checked")==!0&&$("#IsPurchaseOrder").prop("checked",!1)});n.on("click","#purchaseItems .delete-item",function(t){t.preventDefault();$(this).closest("tr").remove();UpdateOrderTotals(n)});n.on("click","#addItem",function(t){t.preventDefault();$.ajax({url:path+"./PurchaseOrder/CreatePurchaseOrderItem",success:function(t){var i=$(t);AdjustPurchaseOrderItem(i,r);r++;$("#purchaseItems").append(i);$(".ItemDescription",n).autogrow({onInitialize:!0,fixMinHeight:!1})},error:function(){alert("Failure communicating with the server.")}})});n.on("change",".OrderQuantity, .EstimatedItemCost",function(){var r=$(this),n=r.closest("tr"),u=this.className.indexOf("EstimatedItemCost")!=-1,t,i;cost=$(".EstimatedItemCost",n).val();t=$(".OrderQuantity",n).val();i=(t*cost).toFixed(2);$(".TotalCost",n).html(i);UpdateOrderTotals()});n.on("change","#EstimatedTaxCost, #EstimatedFreightCost",function(){UpdateOrderTotals()});n.on("click","#clearPurchaseOrder",function(t){t.preventDefault();$("input[type=text], textarea, select",n).val("");$("input[type=checkbox]",n).prop("checked",!1);$(".calculated",n).each(function(){$(this).html("0.00")});$("#SpanPurchaseOrderId").text("0");$("#VendorId").trigger("chosen:updated");$("#VendorAddress").text("");$("#VendorEmail").text("");$("#VendorFax").text("");$("#VendorClass").text("");$("#PurchaseOrderTypeId").trigger("chosen:updated");$("#PurchaseOrderAssetClassId").trigger("chosen:updated");$("#purchaseItems tbody tr").remove();$("#purchaseOrderDocuments tbody tr").remove();UpdateOrderTotals();UpdateAllowFinalApproval()});n.on("change","#IsMarkedForDenial",function(){this.checked?$("#denialComments").show():$("#denialComments").hide()});n.on("click","#submitPurchaseOrder",function(t){t.preventDefault();$("#purchaseItems tr").each(function(n){AdjustPurchaseOrderItem($(this),n-1)});$("#purchaseOrderDocuments tbody tr").each(function(n){i=n;u($(this))});var r=$("#SavePurchaseOrderItem",n),f=n.html(),e=$("#SavePurchaseOrderItem").attr("action");return r.ajaxSubmit({target:"#SavePurchaseOrderItem",success:function(t){try{t.indexOf("<pre>")==0&&(t=t.substring(5,t.length-6));var i=$.parseJSON(t);i.Success?(window.location.replace(path+"PurchaseOrder/"),n.hide()):(n.html(i),InitializeDates(),MonitorAllowFinalApproval(n),SetupCostControls(n),SetupDropDownLists(n))}catch(u){r.html(t);InitializeDates();MonitorAllowFinalApproval(n);SetupCostControls(n);SetupDropDownLists(n);$(".ItemDescription",n).autogrow({onInitialize:!0,fixMinHeight:!1});SetCountDownTime(1800)}},error:function(){alert("Failure communicating with the server.")}}),!1});$("#CensusDateInvalid").val()=="1"&&alert("Error: Please enter a valid Last Census Date (mm/dd/yyyy)");$("#CensusDateInFuture").val()=="1"&&alert("Error: You can not have a Census date that is in the future");$("#CurrentCommunity").change(function(){var n=$("#CurrentCommunity").val();n!=""&&$("#CommunitySelectionForm").submit()});$("#ToDateRangeInvalid").val()=="1"&&alert('Error: Please enter a valid date in the Infection Date Range "To" Field (mm/dd/yyyy)');$("#FromDateRangeInvalid").val()=="1"&&alert('Error: Please enter a valid date in the Infection Date Range "From" Field (mm/dd/yyyy)');$("#ToDateRangeInFuture").val()=="1"&&alert('Error: Please enter a valid date that is not in the future in the Infection Date Range "To" Field');$("#FromDateRangeInFuture").val()=="1"&&alert('Error: Please enter a valid date that is not in the future in the Infection Date Range "From" Field');$("#FromAfterTo").val()=="1"&&alert('Error: You can not have the "From" Date after the "To" Date in the Infection Date Range Fields');InitializeDates();$(".ItemDescription",n).autogrow({onInitialize:!0,fixMinHeight:!1});SetupCostControls(n);SetupDropDownLists(n);MonitorAllowFinalApproval(n);n.on("change","#VendorId",function(){$("#VendorAddress").text("");$("#VendorEmail").text("");$("#VendorFax").text("");$("#VendorClass").text("");var n=$(this).val();n!=""&&$.ajax({url:path+"./PurchaseOrder/GetVendor",dataType:"json",cache:!1,type:"GET",data:{vendorId:n},success:function(n){$("#VendorAddress").html(n.FullAddressRaw);n.Email!==null&&n.Email!==undefined&&$("#VendorEmail").text(n.Email);n.Fax!==null&&n.Fax!==undefined&&$("#VendorFax").text(n.Fax);n.VendorClass!==null&&n.VendorClass!==undefined&&$("#VendorClass").text(n.VendorClass.Name)},error:function(){alert("Server is not responding. Please reload page and try again")}})});i=0;n.on("click","#purchaseOrderDocuments .delete-item",function(n){n.preventDefault();confirm("Do you want to delete this document from the purchase order?")&&$(this).closest("tr").remove()});n.on("click","#purchaseOrderDocuments .delete-item-new",function(n){n.preventDefault();$(this).closest("tr").remove()});n.on("click","#addDocument",function(t){t.preventDefault();$.ajax({url:path+"./PurchaseOrder/CreatePurchaseOrderDocument",success:function(t){var i=$(t);u(i);$("#purchaseOrderDocuments").append(i);n.off("change","input:file");n.on("change","input:file",function(){var n=$(this),i=$(n).attr("id"),t=$(n).val();$("#purchaseOrderDocuments a").each(function(){$(this).text()==t.substring(t.lastIndexOf("\\")+1)&&(alert("Another file with the same name has already been uploaded"),n.replaceWith(n=n.clone(!0)))});$("#purchaseOrderDocuments input:file").each(function(){$(this).attr("id")!=i&&$(this).val()==t&&(alert("Another file with the same name has already been selected"),n.replaceWith(n=n.clone(!0)))})});$("button.delete-item",i).attr("class","delete-item-new")},error:function(){alert("Failure communicating with the server.")}})})}