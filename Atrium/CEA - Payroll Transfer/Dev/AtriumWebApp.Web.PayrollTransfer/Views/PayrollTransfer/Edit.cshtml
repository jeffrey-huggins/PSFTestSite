@using AtriumWebApp.Web.PayrollTransfer.Models.ViewModel
@model PayrollTransferViewModel

@{
    ViewBag.Title = "Edit Payroll Transfer Entry";
}
<div>
    <h2>Edit Payroll Transfer Entry</h2>
    <div id="Edit">
        @* JQuery modal from a url causes the first field to have focus *@
        <span class="ui-helper-hidden-accessible">
            <input autofocus />
        </span>
        @Html.Partial("~/Views/Partial/SideBarSelectionEmployee.cshtml", new EmployeeSidebarViewModel { AppCode = "PRTR", AppController = "PayrollTransfer", ChangeCommunityPath = Url.BaseUrlPath() + "PayrollTransfer/GetEmployeeList", SideBarDDLActionName = "EmpSideDDL" })

        @using (Html.BeginForm(new { onsubmit="return false;" }))
        {
            @Html.AntiForgeryToken()
            @Html.ValidationSummary(true)

            <fieldset>
                <legend>EmployeePayrollTransfer</legend>
                @Html.EditorForModel()

                <div class="half-spacing a-right">
                    <button type="button" id="editSubmit" value="Save" class="action-button">Save</button>
                </div>
                <div class="half-spacing a-left">
                    <button type="button" id="cancel-button" class="action-button">Cancel</button>
                </div>
            </fieldset>
        }
    </div>
    <div>
        @Html.ActionLink("Back to List", "Index", null,null, new { @id = "returnUrl", style = "display:none" })
    </div>

</div>
<script>
    $(document).ready(function () {
        $("#Edit").find("#Communities").change(function (event) {
            refreshEmployeeList($(event.target).closest(".left-column-picker"));
        });

        $("#Edit").find(".DDLTerminated").hide();
        $("#Edit").find("#employeeProps").last().after("<p><b>General Ledger:</b><br /><span id='DDLGL'></span></p>");
        $("#Edit").find("#Communities").attr("disabled", "disabled");
        $("#Edit").find("#EmployeesDropdown").attr("disabled", "disabled");
        $("#Edit").find("#EmployeesDropdown").change(function () {
            $("#Edit").find("#EmployeesDropdown").val($("#Edit").find("#EmployeeId").val());
            var selectedItem = $("#Edit").find("#EmployeesDropdown").find("option:selected");
            var selectedValue = selectedItem.val();
            $("#Edit").find("#DDLEmpl").text(selectedItem.text());
            var hireDate = new Date(selectedItem.data("hd"));
            var termDate = selectedItem.data("td");
            if (termDate) {
                termDate = getDateString(new Date(termDate));
                $("#Edit").find("#DDLDoT").text(termDate);
            }
            else {
                $("#Edit").find("#DDLDoT").text("");
            }
            $("#Edit").find("#DDLDoH").text(getDateString(hireDate));
            $("#Edit").find("#DDLGL").text($("#Edit").find(".source-ledger option:selected").text());
            HideProgress();
        });
        $("#Edit").find("#Communities").val($("#Edit").find("#SourceCommunityId").val());
        $("#Edit").find("#Communities").trigger("change");

        //If you click home link or admin link, reset tab flags
        $("#Edit").find("a.home-link").click(function (e) {
            $.ajax({
                url: returnUrl + "ClearTabVariables",
                cache: false,
                type: "POST"
            });
        });

        if ($("#Edit").find("#Id").val() != "") {

            //initialize values
            $("#Edit").find("#ActiveEmployees").val($("#Edit").find("#EmployeeId").val());
            $("#Edit").find("#SourceCommunity").val($("#Edit").find("#SourceCommunityId").val());
            $("#Edit").find("#SourceGLAccount").val($("#Edit").find("#SourceGeneralLedgerId").val());
            $("#Edit").find("#TransferDate").val();
            $("#Edit").find("#DestinationGLAccount").val($("#Edit").find("#DestinationGeneralLedgerId").val());
            $("#Edit").find("#DestinationCommunity").val($("#Edit").find("#DestinationCommunityId").val());

            //Disable employee, source community (Source GL already disabled)
            $("#Edit").find("#ActiveEmployees").prop("disabled", true);
            $("#Edit").find("#SourceCommunity").prop("disabled", true);
        }


        $("#Edit").find("fieldset").on("blur", ".payroll-transfer-item .transfer-date", function (data) {
            var transferDate = $(data.target);
            if (transferDate.val().length == 6) {
                var month = transferDate.val().substr(0, 2);
                var day = transferDate.val().substr(2, 2);
                var year = "20" + transferDate.val().substr(4, 2);

                var parsedDate = month + "/" + day + "/" + year; //new Date(month + "/" + day + "/" + year);

                transferDate.val(parsedDate);

            }
        });

        $("#Edit").find("#DestinationCommunity").change(function (e) {
            $("#Edit").find("#DestinationCommunityId").val($("#Edit").find("#DestinationCommunity option:selected").val());
        });

        $("#Edit").find("#DestinationGLAccount").change(function (e) {
            $("#Edit").find("#DestinationGeneralLedgerId").val($("#Edit").find("#DestinationGLAccount option:selected").val());
        });

        $(function () {
            $(".isDate").datepicker({
                beforeShow: function (textbox, instance) {
                    instance.dpDiv.css({
                        marginTop: (-textbox.offsetHeight) + "px",
                        marginLeft: textbox.offsetWidth + "px"
                    });
                }
            });
        });
    });
</script>